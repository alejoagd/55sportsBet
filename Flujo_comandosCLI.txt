#Antes de ejecutar cualquier comando validar si estas con el environment activado , ejecutando el siguiente comando
.\.venv\Scripts\Activate.ps1



--------------------------------Cargar nuevos partidos, actualizar estadisticas y resultados predicciones----------------------------------
#1.Insertar los partidos de la proxima fecha en la tabla de matchs (bulk fixtures)
python -m src.fixtures.cli bulk data/fixtures_E0.csv --season-id 2 --league "Premier League" --dayfirst

#2.Generar predicciones de poisson y weinston de los partidos que se jugaran en la proxima fecha 
python -m src.predictions.cli upcoming --season-id 2  --from 2025-09-13 --to 2025-09-14 (FUNCIONA)
python -m src.predictions.cli --season-id 2  --from 2025-08-15 --to 2025-08-18 --models poisson,weinston (YA NO FUNCIONA)

#3.Leer archivo CSV con la data de los resultados, y almacenar informacion en la base de datos de stats
python -m src.ingest.load_unified data/raw/E0.csv --league "Premier League" --div E0 --season-id 2 --dayfirst

#4.Ejecutar para actualizar el campo de error de weinston despues de ingresar los resultados de los partidos
python -m src.predictions.cli score --season-id 2 --from 2025-08-30 --to 2025-08-31 --metric rmse

#5.Ejecutar despues de insertar los resultados para evaluar el resultado de las predicciones
python -m src.predictions.cli evaluate --season-id 2 --from 2025-08-01 --to 2025-08-31


--------------------------------Correr el Frontend----------------------------------
#1. Ejecutar el backend FastApi Uviconrn 
python -m uvicorn src.api:app --reload --host 0.0.0.0 --port 8000

#2.Luego ejecuta en otra terminal ,dentro de la carpeta de frontend el Frontend Vite-React para la ruta 5173
npm run dev

#Url para visualizar el frontend con JSON
http://localhost:8000/api/predictions?season_id=2&date_from=2025-08-30&date_to=2025-08-31

#Url para visualizar el frontend con CSS
http://localhost:5173/

--------------------------------------------Delete BD matches order---------------------
1.Eliminar de Matches-stats bd
2.Eliminar de matchs
3.Automaticamente se eliminana de las otras tablas.

-----------------------------------flujos de claude
# 1. Entrenar Weinston (genera ratings + parÃ¡metros)
python -m src.predictions.cli fit --season-id 2

# 2. Generar predicciones
python -m src.predictions.cli upcoming --season-id 2 --from 2025-08-15 --to 2025-10-05

# 3. Evaluar resultados (solo partidos terminados)
python -m src.predictions.cli evaluate --season-id 2 --from 2025-08-15 --to 2025-10-05

------------------------------------------------------------------------------------------GUIA ORGANIZADA --------------------------
# GuÃ­a de Comandos CLI - 55sportsBet

## Activar Entorno Virtual
**SIEMPRE ejecutar antes de cualquier comando:**
```powershell
.\.venv\Scripts\Activate.ps1
```

---

## ğŸ¤– MÃ‰TODO RECOMENDADO: Script Inteligente

En lugar de ejecutar comandos manualmente, usa el script inteligente:

```bash
python -m src.scripts.update_predictions
```

### **7 Modos Disponibles:**

#### **Modos Individuales:**
1. **ğŸ“¥ FIXTURES** - Cargar nuevos partidos desde CSV (sin resultados)
2. **ğŸ¯ PREDICT** - Generar predicciones para partidos sin resultados
3. **ğŸ“¥ RESULTS** - Cargar resultados de partidos terminados desde CSV
4. **ğŸ“Š EVALUATE** - Evaluar predicciones vs resultados reales
5. **ğŸ”„ RETRAIN** - Re-entrenar modelo Weinston con nuevos datos

#### **Flujos AutomÃ¡ticos:**
6. **ğŸš€ COMPLETE** - Flujo PRE-partidos (FIXTURES â†’ RETRAIN â†’ PREDICT)
7. **ğŸ“Š FINISH** - Flujo POST-partidos (RESULTS â†’ EVALUATE)

### **Ventajas:**
- âœ… Valida archivos CSV antes de cargar
- âœ… Muestra preview de datos antes de insertar
- âœ… Verifica duplicados y datos faltantes
- âœ… Cuenta partidos afectados antes de ejecutar
- âœ… Advierte sobre predicciones que se actualizarÃ¡n
- âœ… Confirma cada paso antes de proceder
- âœ… Mensajes claros con colores (âœ… verde, âš ï¸ amarillo, âŒ rojo)
- âœ… GuÃ­a paso a paso para flujos complejos

### **Flujo TÃ­pico de una Jornada:**

```
ANTES DE LOS PARTIDOS (Modo 6 - COMPLETE):
â”œâ”€ ğŸ“¥ Cargar fixtures desde CSV
â”œâ”€ ğŸ”„ Re-entrenar Weinston
â””â”€ ğŸ¯ Generar predicciones

âš½ LOS PARTIDOS SE JUEGAN

DESPUÃ‰S DE LOS PARTIDOS (Modo 7 - FINISH):
â”œâ”€ ğŸ“¥ Cargar resultados desde CSV
â””â”€ ğŸ“Š Evaluar predicciones
```

---

## ğŸ“… FLUJO MANUAL: Nueva Jornada de Partidos

Si prefieres ejecutar comandos manualmente (no recomendado):

### **Escenario**: Nueva fecha de partidos por jugar

#### **Paso 1: Cargar fixtures de la prÃ³xima fecha**
Inserta los partidos que se jugarÃ¡n en la tabla `matches` (sin resultados aÃºn).

```bash
python -m src.fixtures.cli bulk data/fixtures_E0.csv --season-id 2 --league "Premier League" --dayfirst
```

**ğŸ“‹ QuÃ© hace**: Carga partidos futuros (home_goals y away_goals = NULL)

---

#### **Paso 2: Re-entrenar modelo Weinston (NUEVO)**
âš ï¸ **IMPORTANTE**: Ejecutar ANTES de generar predicciones si hay nuevos partidos terminados.

```bash
python -m src.predictions.cli fit --season-id 2
```

**ğŸ“‹ QuÃ© hace**: 
- Recalcula ratings de equipos (atk_home, def_home, atk_away, def_away)
- Actualiza parÃ¡metros de liga (Î¼_home, Î¼_away, home_advantage)
- Guarda todo en `weinston_ratings` y `weinston_params`

**â±ï¸ CuÃ¡ndo ejecutar**:
- DespuÃ©s de cargar resultados de partidos terminados (antes del Paso 5)
- Al inicio de cada nueva jornada si hubo partidos en la jornada anterior

---

#### **Paso 3: Generar predicciones para prÃ³xima fecha**
Genera predicciones de Poisson y Weinston para partidos sin resultado.

```bash
# OpciÃ³n 1: Por rango de fechas (RECOMENDADO)
python -m src.predictions.cli upcoming --season-id 2 --from 2025-09-13 --to 2025-09-14

# OpciÃ³n 2: Especificar modelos explÃ­citamente
python -m src.predictions.cli upcoming --season-id 2 --from 2025-09-13 --to 2025-09-14 --models poisson,weinston
```

**ğŸ“‹ QuÃ© hace**: 
- Lee ratings y parÃ¡metros actualizados
- Genera predicciones en `poisson_predictions` y `weinston_predictions`

**ğŸ’¡ Tip**: Si ves "âš ï¸ No hay parÃ¡metros Weinston, usando fallback", ejecuta primero el Paso 2.

---

#### **Paso 4: Los partidos se juegan** âš½
*(AquÃ­ esperas a que los partidos terminen y obtengas los resultados reales)*

---

#### **Paso 5: Cargar resultados reales**
Lee el CSV con resultados y actualiza la BD con goles y estadÃ­sticas.

```bash
python -m src.ingest.load_unified data/raw/E0.csv --league "Premier League" --div E0 --season-id 2 --dayfirst
```

**ğŸ“‹ QuÃ© hace**: 
- Actualiza `home_goals`, `away_goals` en `matches`
- Inserta estadÃ­sticas del partido en `match_stats`

**ğŸ’¡ Alternativa inteligente**: Usa `python src/scripts/update_predictions.py` y selecciona modo 3 (RESULTS)

---

#### **Paso 6: Calcular RMSE de Weinston**
Calcula el error de predicciÃ³n de goles de Weinston.

```bash
python -m src.predictions.cli score --season-id 2 --from 2025-09-13 --to 2025-09-14 --metric rmse
```

**ğŸ“‹ QuÃ© hace**: Actualiza campo `error` en `weinston_predictions`

---

#### **Paso 7: Evaluar precisiÃ³n de predicciones**
Compara predicciones vs resultados reales y calcula porcentajes de acierto.

```bash
python -m src.predictions.cli evaluate --season-id 2 --from 2025-09-13 --to 2025-09-14
```

**ğŸ“‹ QuÃ© hace**: 
- Crea/actualiza registros en `prediction_outcomes`
- Calcula aciertos de 1X2, Over/Under 2.5, BTTS
- Calcula RMSE de goles para Weinston

---

#### **Paso 8: Volver al Paso 2** ğŸ”„
Para la siguiente jornada, vuelve al **Paso 2** (re-entrenar Weinston con los nuevos datos).

---

## ğŸš€ Script Automatizado (Recomendado)

Crea `update_predictions.py` para automatizar todo:

```python
# src/scripts/update_predictions.py
import subprocess
from datetime import datetime

season_id = 2
date_from = "2025-09-13"
date_to = "2025-09-14"

commands = [
    # 1. Re-entrenar Weinston
    f"python -m src.predictions.cli fit --season-id {season_id}",
    
    # 2. Generar predicciones
    f"python -m src.predictions.cli upcoming --season-id {season_id} --from {date_from} --to {date_to}",
    
    # 3. Calcular RMSE (despuÃ©s de cargar resultados)
    f"python -m src.predictions.cli score --season-id {season_id} --from {date_from} --to {date_to} --metric rmse",
    
    # 4. Evaluar
    f"python -m src.predictions.cli evaluate --season-id {season_id} --from {date_from} --to {date_to}",
]

for cmd in commands:
    print(f"\nğŸ”„ {cmd}")
    subprocess.run(cmd, shell=True, check=True)

print("\nâœ… Â¡ActualizaciÃ³n completa!")
```

**Ejecutar**:
```bash
python src/scripts/update_predictions.py
```

---

## ğŸ–¥ï¸ Correr el Frontend

### **Backend (FastAPI)**
```bash
python -m uvicorn src.api:app --reload --host 0.0.0.0 --port 8000
```

### **Frontend (Vite-React)** *(en otra terminal)*
```bash
cd frontend
npm run dev
```

### **URLs Ãºtiles**:
- **API JSON**: http://localhost:8000/api/predictions?season_id=2&date_from=2025-08-30&date_to=2025-08-31
- **Frontend**: http://localhost:5173/
- **API Docs**: http://localhost:8000/docs

---

## ğŸ—‘ï¸ Eliminar Datos (Orden correcto)

**IMPORTANTE**: Respetar este orden por dependencias de FK:

1. Eliminar de `match_stats`
2. Eliminar de `matches`
3. Las otras tablas se limpian automÃ¡ticamente (CASCADE)

```sql
-- Eliminar partidos de una jornada especÃ­fica
DELETE FROM match_stats WHERE match_id IN (
    SELECT id FROM matches WHERE season_id = 2 AND date BETWEEN '2025-09-13' AND '2025-09-14'
);

DELETE FROM matches WHERE season_id = 2 AND date BETWEEN '2025-09-13' AND '2025-09-14';
```

---

## ğŸ“Š Comandos de VerificaciÃ³n

### **Ver estado de predicciones**
```sql
SELECT 
    m.date, 
    t1.name as home, 
    t2.name as away,
    pp.prob_home_win, 
    wp.result_1x2,
    m.home_goals, 
    m.away_goals
FROM matches m
LEFT JOIN teams t1 ON t1.id = m.home_team_id
LEFT JOIN teams t2 ON t2.id = m.away_team_id
LEFT JOIN poisson_predictions pp ON pp.match_id = m.id
LEFT JOIN weinston_predictions wp ON wp.match_id = m.id
WHERE m.season_id = 2 AND m.date BETWEEN '2025-09-13' AND '2025-09-14'
ORDER BY m.date;
```

### **Ver mÃ©tricas de modelos**
```sql
SELECT 
    model,
    COUNT(*) as total,
    ROUND(AVG((hit_1x2)::int)::numeric * 100, 1) as acierto_1x2,
    ROUND(AVG((hit_over25)::int)::numeric * 100, 1) as acierto_over25,
    ROUND(AVG((hit_btts)::int)::numeric * 100, 1) as acierto_btts,
    ROUND(AVG(rmse_goals)::numeric, 3) as rmse
FROM prediction_outcomes po
JOIN matches m ON m.id = po.match_id
WHERE m.season_id = 2
GROUP BY model;
```

### **Ver diferencias entre modelos**
```sql
SELECT 
    COUNT(*) as total,
    COUNT(*) FILTER (WHERE p.pick_1x2 = w.pick_1x2) as iguales,
    COUNT(*) FILTER (WHERE p.pick_1x2 != w.pick_1x2) as diferentes,
    ROUND(100.0 * COUNT(*) FILTER (WHERE p.pick_1x2 != w.pick_1x2) / COUNT(*), 1) as pct_dif
FROM prediction_outcomes p
JOIN prediction_outcomes w ON p.match_id = w.match_id AND w.model = 'weinston'
WHERE p.model = 'poisson';
```

---

## ğŸ”§ Troubleshooting

### **Error: "No hay parÃ¡metros Weinston"**
**SoluciÃ³n**: Ejecutar `python -m src.predictions.cli fit --season-id 2`

### **Predicciones idÃ©nticas entre modelos**
**SoluciÃ³n**: 
1. Verificar que ejecutaste `fit` despuÃ©s de cargar nuevos resultados
2. Regenerar predicciones con `upcoming`
3. Re-evaluar con `evaluate`

### **RMSE vacÃ­o en Poisson**
**Normal**: Poisson no predice goles exactos, solo probabilidades.

### **Frontend muestra datos viejos**
**SoluciÃ³n**: Hacer clic en botÃ³n "Refrescar" o recargar la pÃ¡gina (F5)

---

## ğŸ“ Notas Importantes

1. **Siempre re-entrenar Weinston** despuÃ©s de cargar nuevos resultados y antes de generar nuevas predicciones
2. **El orden importa**: fit â†’ upcoming â†’ (partidos se juegan) â†’ load results â†’ score â†’ evaluate
3. **Weinston es superior a Poisson** en la mayorÃ­a de mÃ©tricas (~10% mejor en 1X2, ~25% mejor en BTTS)
4. **Fallback automÃ¡tico**: Si no hay parÃ¡metros Weinston, usa promedios de liga (menos preciso)

---

## ğŸ¯ Resumen Visual del Flujo

### **Ciclo Completo de una Jornada:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JORNADA N                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. ğŸ“¥ CARGAR FIXTURES (CSV â†’ BD)                          â”‚
â”‚     â”œâ”€ Obtener CSV con fixtures de la jornada              â”‚
â”‚     â”œâ”€ Ejecutar: FIXTURES mode                             â”‚
â”‚     â””â”€ Resultado: Partidos en BD sin resultados            â”‚
â”‚                                                             â”‚
â”‚  2. ğŸ”„ RE-ENTRENAR WEINSTON                                â”‚
â”‚     â”œâ”€ Usa partidos terminados hasta ahora                 â”‚
â”‚     â”œâ”€ Ejecutar: RETRAIN mode                              â”‚
â”‚     â””â”€ Resultado: Ratings y parÃ¡metros actualizados        â”‚
â”‚                                                             â”‚
â”‚  3. ğŸ¯ GENERAR PREDICCIONES                                â”‚
â”‚     â”œâ”€ Usa ratings actualizados                            â”‚
â”‚     â”œâ”€ Ejecutar: PREDICT mode                              â”‚
â”‚     â””â”€ Resultado: Predicciones Poisson + Weinston          â”‚
â”‚                                                             â”‚
â”‚  4. âš½ PARTIDOS SE JUEGAN                                   â”‚
â”‚     â””â”€ (Esperar resultados reales)                         â”‚
â”‚                                                             â”‚
â”‚  5. ğŸ“¥ CARGAR RESULTADOS (CSV â†’ BD)                        â”‚
â”‚     â”œâ”€ Obtener CSV con resultados y stats                  â”‚
â”‚     â”œâ”€ Ejecutar: load_unified                              â”‚
â”‚     â””â”€ Resultado: home_goals/away_goals actualizados       â”‚
â”‚                                                             â”‚
â”‚  6. ğŸ“Š EVALUAR PREDICCIONES                                â”‚
â”‚     â”œâ”€ Compara predicciones vs resultados                  â”‚
â”‚     â”œâ”€ Ejecutar: EVALUATE mode                             â”‚
â”‚     â””â”€ Resultado: % de acierto calculados                  â”‚
â”‚                                                             â”‚
â”‚  ğŸ”„ VOLVER AL PASO 1 para JORNADA N+1                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **OpciÃ³n RÃ¡pida (Script Inteligente - Modo COMPLETE):**

```
Un solo comando ejecuta:
FIXTURES â†’ RETRAIN â†’ PREDICT

Luego manualmente:
RESULTADOS â†’ EVALUATE
```